<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CycleScreener PWA</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
    <style>
        :root { --dark-bg: #1a1d21; --dark-card: #272a2e; --border: #444; --text: #f0f0f0; }
        html, body { background-color: var(--dark-bg); color: var(--text); height: 100%; margin: 0; font-family: sans-serif; overflow: hidden; }
        .navbar { background-color: var(--dark-card); border-bottom: 1px solid var(--border); }
        .navbar-item { color: var(--text) !important; }
        .input { background-color: var(--dark-bg); border-color: var(--border); color: var(--text); }
        .page { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        .page-content { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .chart-wrapper { background-color: var(--dark-card); border-radius: 8px; height: 260px; position: relative; margin-bottom: 1rem; width: 100%; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #settingsPage { display: none; }
    </style>
</head>
<body>

    <div id="mainPage" class="page">
        <nav class="navbar">
            <div class="navbar-brand">
                <div id="statusTag" class="navbar-item has-text-weight-bold">CycleScreener</div>
                <div class="navbar-item">
                    <input class="input is-small" type="text" id="tickerInput" value="VT" style="width: 80px;">
                    <button id="btnFetch" class="button is-info is-small ml-2">Fetch</button>
                </div>
            </div>
        </nav>

        <main class="page-content">
            <div id="msg" class="has-text-centered is-size-7 has-text-grey mb-2">Ready</div>
            <div class="chart-wrapper"><canvas id="priceChart"></canvas></div>
            <div class="chart-wrapper"><canvas id="macdChart"></canvas></div>
            <div class="chart-wrapper"><canvas id="ecoChart"></canvas></div>
            <div class="chart-wrapper"><canvas id="ecoMacdChart"></canvas></div>
        </main>
    </div>

    <script>
        (function() {
            const PHASES = { DOWNTREND: 'DOWNTREND', NEW_UPTREND: 'NEW_UPTREND', LATE_UPTREND: 'LATE_UPTREND', PRE_DOWNTREND: 'PRE_DOWNTREND' };
            let state = { dates: [], prices: [], eco: null };

            const $ = (id) => document.getElementById(id);
            $('btnFetch').onclick = fetchData;

            async function fetchData() {
                const ticker = $('tickerInput').value.trim().toUpperCase();
                $('msg').textContent = "Contacting server...";
                $('msg').className = "has-text-centered is-size-7 has-text-grey mb-2";

                try {
                    const [pRes, eRes] = await Promise.all([
                        fetch(`/api/price/${ticker}`),
                        fetch(`/api/economic`)
                    ]);

                    if (!pRes.ok) {
                        const errData = await pRes.json();
                        throw new Error(errData.error || "Stock data failed");
                    }
                    if (!eRes.ok) throw new Error("Economic data failed");
                    
                    const pJson = await pRes.json();
                    const eCsv = await eRes.text();

                    parseYahooPrices(pJson);
                    state.eco = parseEco(eCsv);
                    
                    $('msg').textContent = `Success: Loaded ${ticker}`;
                    render();
                } catch (e) { 
                    $('msg').textContent = `Error: ${e.message}`; 
                    $('msg').className = "has-text-centered is-size-7 has-text-danger mb-2";
                }
            }

            function parseYahooPrices(json) {
                const result = json.chart.result[0];
                const timestamps = result.timestamp || [];
                const quotes = result.indicators.quote[0].close || [];
                state.dates = []; state.prices = [];
                timestamps.forEach((ts, i) => {
                    if (quotes[i] != null) {
                        state.dates.push(new Date(ts * 1000).toISOString().split('T')[0]);
                        state.prices.push(quotes[i]);
                    }
                });
            }

            function parseEco(csv) {
                const lines = csv.trim().split('\n');
                lines.shift();
                return lines.map(l => {
                    const [d, v] = l.split(',');
                    return { d, v: parseFloat(v) };
                }).filter(o => !isNaN(o.v));
            }

            const ema = (data, p) => {
                const k = 2/(p+1), res = new Array(data.length).fill(null);
                if (data.length < p) return res;
                let sum = 0; for(let i=0; i<p; i++) sum += data[i];
                res[p-1] = sum/p;
                for(let i=p; i<data.length; i++) res[i] = data[i]*k + res[i-1]*(1-k);
                return res;
            };

            const getMACD = (data) => {
                const e12 = ema(data, 12), e26 = ema(data, 26);
                const ml = e12.map((v, i) => (v && e26[i]) ? v - e26[i] : null);
                const sl = ema(ml.filter(v => v !== null), 9);
                const fullSl = new Array(ml.length - sl.length).fill(null).concat(sl);
                const hist = ml.map((v, i) => (v !== null && fullSl[i] !== null) ? v - fullSl[i] : null);
                return { ml, sl: fullSl, hist };
            };

            function render() {
                const stock = {
                    p: state.prices,
                    f: ema(state.prices, 10),
                    s: ema(state.prices, 20),
                    macd: getMACD(state.prices)
                };

                let alignedEco = null;
                if (state.eco) {
                    const vals = state.dates.map(d => {
                        const m = [...state.eco].reverse().find(e => e.d <= d);
                        return m ? m.v : null;
                    });
                    alignedEco = { v: vals, f: ema(vals, 10), macd: getMACD(vals) };
                }

                const phases = new Array(stock.p.length).fill(PHASES.DOWNTREND);
                for(let i=1; i<stock.p.length; i++){
                    const f=stock.f[i], s=stock.s[i], ml=stock.macd.ml[i], sl=stock.macd.sl[i], prev=phases[i-1];
                    if(!f || !s) continue;
                    if(f < s) phases[i] = PHASES.DOWNTREND;
                    else {
                        if(prev === PHASES.DOWNTREND) phases[i] = PHASES.NEW_UPTREND;
                        else if(ml < sl) {
                            const ecoHist = alignedEco ? alignedEco.macd.hist[i] : 0;
                            if(ecoHist < 0 && stock.macd.hist[i] < stock.macd.hist[i-1]) phases[i] = PHASES.PRE_DOWNTREND;
                            else phases[i] = PHASES.LATE_UPTREND;
                        } else phases[i] = PHASES.NEW_UPTREND;
                    }
                }

                const start = Math.max(0, state.dates.length - 260); // Show last 5 years
                drawPrice($('priceChart'), state.dates.slice(start), stock, phases.slice(start));
                drawMacd($('macdChart'), stock.macd, start, "Stock MACD");
                if (alignedEco) {
                    drawPrice($('ecoChart'), state.dates.slice(start), {p:alignedEco.v, f:alignedEco.f}, null, "Job Openings");
                    drawMacd($('ecoMacdChart'), alignedEco.macd, start, "Economic MACD");
                }
                $('statusTag').textContent = phases[phases.length-1].replace('_',' ');
            }

            function setup(can) {
                const dpr = window.devicePixelRatio || 1, b = can.getBoundingClientRect();
                can.width = b.width * dpr; can.height = b.height * dpr;
                const ctx = can.getContext('2d'); ctx.scale(dpr, dpr);
                return { ctx, w: b.width, h: b.height };
            }

            function drawPrice(can, dates, data, phases, label="Price") {
                const {ctx, w, h} = setup(can);
                const p = data.p.slice(-dates.length), filtered = p.filter(v=>v!=null);
                const min = Math.min(...filtered), max = Math.max(...filtered);
                const pad = 30, getX = (i) => pad + (i/(dates.length-1))*(w-pad*2), getY = (v) => h-pad - ((v-min)/(max-min))*(h-pad*2);

                if(phases) phases.forEach((ph, i) => {
                    const colors = {DOWNTREND:'#ff386022', NEW_UPTREND:'#23d16022', LATE_UPTREND:'#ffdd5722', PRE_DOWNTREND:'#ff980022'};
                    ctx.fillStyle = colors[ph];
                    ctx.fillRect(getX(i), pad, getX(i+1)-getX(i)+1, h-pad*2);
                });

                ctx.beginPath(); ctx.strokeStyle = '#3273dc';
                p.forEach((v, i) => i === 0 ? ctx.moveTo(getX(i), getY(v)) : ctx.lineTo(getX(i), getY(v)));
                ctx.stroke();
                ctx.fillStyle = '#a0a0a0'; ctx.fillText(label, 10, 20);
            }

            function drawMacd(can, macd, start, label) {
                const {ctx, w, h} = setup(can);
                const hst = macd.hist.slice(start), filtered = hst.filter(v=>v!=null);
                const min = Math.min(...filtered), max = Math.max(...filtered);
                const pad = 30, getX = (i) => pad + (i/(hst.length-1))*(w-pad*2), getY = (v) => h-pad - ((v-min)/(max-min))*(h-pad*2);
                const zero = getY(0);

                hst.forEach((v, i) => {
                    if (v == null) return;
                    ctx.fillStyle = v >= 0 ? '#23d16088' : '#ff386088';
                    ctx.fillRect(getX(i)-1, getY(v), 2, zero - getY(v));
                });
                ctx.fillStyle = '#a0a0a0'; ctx.fillText(label, 10, 20);
            }

            fetchData();
        })();
    </script>
</body>
</html>