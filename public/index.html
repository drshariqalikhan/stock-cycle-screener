<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Stock & Economic Cycle Screener</title>
    
    <meta name="theme-color" content="#1a1d21">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">

    <style>
        :root { --dark-bg-1: #1a1d21; --dark-bg-2: #272a2e; --dark-border: #444; --light-text: #f0f0f0; --dim-text: #a0a0a0; }
        html { background-color: var(--dark-bg-1); height: 100svh; }
        body { background-color: var(--dark-bg-1); color: var(--light-text); display: flex; flex-direction: column; height: 100%; margin: 0; }
        .navbar { background-color: var(--dark-bg-2); border-bottom: 1px solid var(--dark-border); }
        .navbar-item, .navbar-link { color: var(--light-text); cursor: pointer; }
        .navbar-burger span { background-color: var(--light-text); }
        .input, .select select { background-color: var(--dark-bg-1); border-color: var(--dark-border); color: var(--light-text); }
        input[type="color"] { min-height: 2.5em; padding: 0.25em; }
        .label { color: var(--light-text); }
        
        .page { display: flex; flex-direction: column; height: 100%; width: 100%; }
        #settingsPage { display: none; }
        .page-nav { padding-top: env(safe-area-inset-top); flex-shrink: 0; }
        .page-content { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: env(safe-area-inset-bottom); display: flex; flex-direction: column;}

        #appContainer { display: flex; flex-direction: column; gap: 1rem; height: 100%; padding: 1rem; }
        .chart-wrapper { background-color: var(--dark-bg-2); border-radius: 6px; flex: 1; position: relative; min-height: 200px; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .content-container { padding: 1.5rem; }
        .settings-field { max-width: 400px; margin-bottom: 1.5rem; }
        .slider-container { display: flex; align-items: center; gap: 1rem; }
    </style>
</head>
<body>

    <!-- PAGE 1: MAIN PAGE -->
    <div id="mainPage" class="page">
        <nav class="navbar page-nav" role="navigation">
            <div class="navbar-brand">
                <div id="currentPhaseStatus" class="navbar-item has-text-weight-bold"></div>
                <a role="button" class="navbar-burger" data-target="navbarBasicMenu"><span></span><span></span><span></span></a>
            </div>
            <div id="navbarBasicMenu" class="navbar-menu">
                <div class="navbar-start">
                    <div class="navbar-item"><div class="field is-grouped"><p class="control is-expanded"><input class="input" type="text" id="tickerInput" value="VT"></p><p class="control"><button id="fetchButton" class="button is-info">Fetch</button></p></div></div>
                    <a class="navbar-item" id="goToSettingsButton">Settings</a>
                </div>
            </div>
        </nav>
        <main class="page-content">
            <div id="appContainer">
                <div id="priceChartWrapper" class="chart-wrapper"><canvas id="priceChart"></canvas></div>
                <div id="macdChartWrapper" class="chart-wrapper"><canvas id="macdChart"></canvas></div>
                <div id="economicChartWrapper" class="chart-wrapper"><canvas id="economicChart"></canvas></div>
                <div id="economicMACDChartWrapper" class="chart-wrapper"><canvas id="economicMACDChart"></canvas></div>
                <div id="statusMessage" class="has-text-centered is-size-7 has-text-grey" role="status"></div>
            </div>
        </main>
    </div>

    <!-- PAGE 2: SETTINGS PAGE -->
    <div id="settingsPage" class="page">
        <nav class="navbar page-nav">
            <div class="navbar-brand"><a class="navbar-item" id="backBtn">< Back</a></div>
            <div class="navbar-menu is-active"><div class="navbar-start"><div class="navbar-item has-text-weight-bold">Settings</div></div></div>
        </nav>
        <main class="page-content"><div class="content-container" id="settingsContainer"></div></main>
    </div>
    
    <script>
        (function() {
            // --- SECTION 1: CONSTANTS AND STATE ---
            const LAST_TICKER_KEY = 'stockcycle_lastTicker';
            const SETTINGS_KEY = 'stockcycle_settings';
            const PHASES = { DOWNTREND: 'DOWNTREND', NEW_UPTREND: 'NEW_UPTREND', LATE_UPTREND: 'LATE_UPTREND', PRE_DOWNTREND: 'PRE_DOWNTREND' };
            let allDates = [], allPrices = [], economicDataRaw = null;
            
            // --- SECTION 2: DOM ELEMENT REFERENCES ---
            let tickerInput, fetchButton, statusMessage, currentPhaseStatus, timePeriodSelector, fastEmaInput, slowEmaInput, sma1Input, sma2Input, preDowntrendHistogramsInput, preDowntrendHistogramsValue;

            // --- SECTION 3: INITIALIZATION ---
            document.addEventListener('DOMContentLoaded', () => {
                tickerInput = document.getElementById('tickerInput');
                fetchButton = document.getElementById('fetchButton');
                statusMessage = document.getElementById('statusMessage');
                currentPhaseStatus = document.getElementById('currentPhaseStatus');

                document.getElementById('goToSettingsButton').onclick = () => { document.getElementById('mainPage').style.display='none'; document.getElementById('settingsPage').style.display='flex'; };
                document.getElementById('backBtn').onclick = () => { document.getElementById('settingsPage').style.display='none'; document.getElementById('mainPage').style.display='flex'; };
                
                const burger = document.querySelector('.navbar-burger');
                burger.onclick = () => { burger.classList.toggle('is-active'); document.getElementById('navbarBasicMenu').classList.toggle('is-active'); };
                
                buildSettingsPage();
                loadSettings();
                
                const lastTicker = localStorage.getItem(LAST_TICKER_KEY);
                if (lastTicker) tickerInput.value = lastTicker;

                fetchButton.onclick = fetchData;
                tickerInput.onkeypress = (e) => { if (e.key === 'Enter') fetchData(); };
                
                fetchData();
            });
            
            // --- SECTION 4: DATA FETCHING ---
            async function fetchData() {
                const ticker = tickerInput.value.trim().toUpperCase();
                statusMessage.textContent = `Fetching data for ${ticker}...`;
                try {
                    const [pRes, eRes] = await Promise.all([fetch(`/api/price/${ticker}`), fetch(`/api/economic`)]);
                    if (!pRes.ok) throw new Error("Stock data fetch failed.");
                    
                    const pJson = await pRes.json();
                    const res = pJson.chart.result[0];
                    const ts = res.timestamp;
                    const cl = res.indicators.quote[0].close;
                    
                    allDates = []; allPrices = [];
                    ts.forEach((t, i) => {
                        if (cl[i] != null) {
                            allDates.push(new Date(t * 1000).toISOString().split('T')[0]);
                            allPrices.push(cl[i]);
                        }
                    });

                    const eCsv = await eRes.text();
                    const lines = eCsv.trim().split('\n');
                    lines.shift();
                    economicDataRaw = lines.map(l => {
                        const [date, val] = l.split(',');
                        return { date, value: parseFloat(val) };
                    }).filter(d => !isNaN(d.value));

                    localStorage.setItem(LAST_TICKER_KEY, ticker);
                    statusMessage.textContent = `Displaying ${ticker}.`;
                    processAndDraw();
                } catch (e) { statusMessage.textContent = e.message; }
            }

            // --- SECTION 5: CORE LOGIC (ORIGINAL CYCLE ALGORITHM) ---
            function processAndDraw() {
                if (!allPrices || allPrices.length === 0) return;
                const s = getSettings();
                const fastP = parseInt(s.fastEma), slowP = parseInt(s.slowEma), sma1P = parseInt(s.sma1), sma2P = parseInt(s.sma2), histP = parseInt(s.preDowntrendHistograms);

                const stockMacdData = calculateMACD(allPrices);
                const stockFull = {
                    fastEma: calculateEMA(allPrices, fastP), slowEma: calculateEMA(allPrices, slowP),
                    sma1: calculateSMA(allPrices, sma1P), sma2: calculateSMA(allPrices, sma2P),
                    ...stockMacdData
                };

                let ecoIndicators = null;
                if (economicDataRaw) {
                    const alignedValues = allDates.map(d => {
                        const m = [...economicDataRaw].reverse().find(e => e.date <= d);
                        return m ? m.value : null;
                    });
                    ecoIndicators = {
                        values: alignedValues,
                        fastEma: calculateEMA(alignedValues, fastP),
                        slowEma: calculateEMA(alignedValues, slowP),
                        ...calculateMACD(alignedValues)
                    };
                }

                // EXACT CYCLE ALGORITHM FROM ORIGINAL FILE
                const phases = determineCyclePhases(stockFull, histP, ecoIndicators);
                updateCurrentPhaseStatus(phases, allDates, s);

                const startIdx = getFilterStartIndex(s.timePeriod);
                const slicedDates = allDates.slice(startIdx);
                const slicedData = {
                    prices: allPrices.slice(startIdx),
                    fastEma: stockFull.fastEma.slice(startIdx), slowEma: stockFull.slowEma.slice(startIdx),
                    sma1: stockFull.sma1.slice(startIdx), sma2: stockFull.sma2.slice(startIdx),
                    macdLine: stockFull.macdLine.slice(startIdx), signalLine: stockFull.signalLine.slice(startIdx),
                    histogram: stockFull.histogram.slice(startIdx), phases: phases.slice(startIdx),
                    economic: ecoIndicators ? {
                        values: ecoIndicators.values.slice(startIdx),
                        fastEma: ecoIndicators.fastEma.slice(startIdx), slowEma: ecoIndicators.slowEma.slice(startIdx),
                        macdLine: ecoIndicators.macdLine.slice(startIdx), signalLine: ecoIndicators.signalLine.slice(startIdx),
                        histogram: ecoIndicators.histogram.slice(startIdx)
                    } : null
                };

                drawPriceChart(slicedDates, slicedData, s);
                drawMacdChart('macdChart', slicedDates, slicedData.macdLine, slicedData.signalLine, slicedData.histogram, "Stock MACD");
                if (slicedData.economic) {
                    drawEcoChart(slicedDates, slicedData.economic, fastP, slowP);
                    drawMacdChart('economicMACDChart', slicedDates, slicedData.economic.macdLine, slicedData.economic.signalLine, slicedData.economic.histogram, "Economic MACD");
                }
            }

            function determineCyclePhases(stock, histogramCount, eco) {
                const { fastEma, slowEma, macdLine, signalLine, histogram } = stock;
                const phases = new Array(fastEma.length).fill(PHASES.DOWNTREND);
                
                for (let i = 1; i < fastEma.length; i++) {
                    const fe_c = fastEma[i], se_c = slowEma[i];
                    const ml_c = macdLine[i], ml_p = macdLine[i - 1];
                    const sl_c = signalLine[i], sl_p = signalLine[i - 1];
                    const previousPhase = phases[i - 1];

                    if ([fe_c, se_c, ml_c, ml_p, sl_c, sl_p].some(v => v === null)) {
                        phases[i] = previousPhase; continue;
                    }

                    if (fe_c < se_c) {
                        phases[i] = PHASES.DOWNTREND; continue;
                    }

                    switch (previousPhase) {
                        case PHASES.DOWNTREND:
                            phases[i] = PHASES.NEW_UPTREND; break;
                        case PHASES.NEW_UPTREND:
                            if (ml_p > sl_p && ml_c <= sl_c) { phases[i] = PHASES.LATE_UPTREND; } 
                            else { phases[i] = PHASES.NEW_UPTREND; }
                            break;
                        case PHASES.LATE_UPTREND:
                            let isPreTrigger = true;
                            if (i <= histogramCount) { isPreTrigger = false; } 
                            else {
                                for (let j = 0; j < histogramCount; j++) {
                                    const hC = histogram[i-j], hP = histogram[i-j-1];
                                    if (hC === null || hP === null || hC >= 0 || hP >= 0 || hC >= hP) {
                                        isPreTrigger = false; break;
                                    }
                                }
                                if (isPreTrigger && eco) {
                                    if (!eco.histogram || eco.histogram[i] === null || eco.histogram[i] >= 0) isPreTrigger = false;
                                } else { isPreTrigger = false; }
                            }
                            phases[i] = isPreTrigger ? PHASES.PRE_DOWNTREND : PHASES.LATE_UPTREND;
                            break;
                        case PHASES.PRE_DOWNTREND:
                            phases[i] = PHASES.PRE_DOWNTREND; break;
                    }
                }
                return phases;
            }

            // --- SECTION 6: CALCULATIONS & CHARTING ---
            function calculateSMA(d, p) { 
                const s = new Array(d.length).fill(null); 
                for(let i=p-1; i<d.length; i++) { 
                    let sum = 0; for(let j=0; j<p; j++) sum += d[i-j]; 
                    s[i] = sum/p; 
                } return s; 
            }
            function calculateEMA(d, p) { 
                const k = 2/(p+1), e = new Array(d.length).fill(null); 
                let sum = 0; for(let i=0; i<p; i++) sum += d[i]; 
                e[p-1] = sum/p; 
                for(let i=p; i<d.length; i++) e[i] = (d[i]*k) + (e[i-1]*(1-k)); 
                return e; 
            }
            function calculateMACD(d) {
                const e12 = calculateEMA(d, 12), e26 = calculateEMA(d, 26);
                const ml = e12.map((v,i) => (v && e26[i]) ? v - e26[i] : null);
                const sl = calculateEMA(ml.filter(v => v !== null), 9);
                const fsl = new Array(ml.length - sl.length).fill(null).concat(sl);
                const h = ml.map((v,i) => (v !== null && fsl[i] !== null) ? v - fsl[i] : null);
                return { macdLine: ml, signalLine: fsl, histogram: h };
            }

            function drawPriceChart(dates, data, s) {
                const can = document.getElementById('priceChart'), ctx = can.getContext('2d');
                const b = can.parentElement.getBoundingClientRect();
                can.width = b.width * devicePixelRatio; can.height = b.height * devicePixelRatio;
                ctx.scale(devicePixelRatio, devicePixelRatio);
                
                const all = [...data.prices, ...data.fastEma.filter(v=>v), ...data.slowEma.filter(v=>v)];
                const min = Math.min(...all), max = Math.max(...all);
                const m = {t:20, b:30, l:50, r:10}, w = b.width, h = b.height;
                const getX = (i) => m.l + (i/(dates.length-1))*(w-m.l-m.r);
                const getY = (v) => h - m.b - ((v-min)/(max-min))*(h-m.t-m.b);

                data.phases.forEach((ph, i) => {
                    ctx.fillStyle = s[ph.toLowerCase()+'Color'] + '26';
                    ctx.fillRect(getX(i), m.t, getX(i+1)-getX(i)+1 || 1, h-m.t-m.b);
                });

                const drawL = (d, col, lw=1) => {
                    ctx.beginPath(); ctx.strokeStyle = col; ctx.lineWidth = lw;
                    d.forEach((v, i) => { if(v) i===0?ctx.moveTo(getX(i), getY(v)):ctx.lineTo(getX(i), getY(v)); });
                    ctx.stroke();
                };
                drawL(data.prices, '#a0a0a0', 1.5); drawL(data.fastEma, '#3273dc'); drawL(data.slowEma, '#23d160');
                drawL(data.sma1, '#ff9800'); drawL(data.sma2, '#c56bf0');
            }

            function drawMacdChart(id, dates, ml, sl, hst, label) {
                const can = document.getElementById(id), ctx = can.getContext('2d');
                const b = can.parentElement.getBoundingClientRect();
                can.width = b.width * devicePixelRatio; can.height = b.height * devicePixelRatio;
                ctx.scale(devicePixelRatio, devicePixelRatio);
                
                const all = [...ml.filter(v=>v), ...sl.filter(v=>v), ...hst.filter(v=>v)];
                const min = Math.min(...all), max = Math.max(...all);
                const m = {t:20, b:20, l:50, r:10}, w = b.width, h = b.height;
                const getX = (i) => m.l + (i/(dates.length-1))*(w-m.l-m.r);
                const getY = (v) => h - m.b - ((v-min)/(max-min))*(h-m.t-m.b);
                const zero = getY(0);

                hst.forEach((v, i) => {
                    if(v==null) return;
                    ctx.fillStyle = v >= 0 ? 'rgba(35,209,96,0.7)' : 'rgba(255,56,96,0.7)';
                    ctx.fillRect(getX(i)-1, getY(v), 2, zero - getY(v));
                });
                const drawL = (d, col) => {
                    ctx.beginPath(); ctx.strokeStyle = col;
                    d.forEach((v, i) => { if(v) i===0?ctx.moveTo(getX(i), getY(v)):ctx.lineTo(getX(i), getY(v)); });
                    ctx.stroke();
                };
                drawL(ml, '#007bff'); drawL(sl, '#fd7e14');
                ctx.fillStyle = '#a0a0a0'; ctx.fillText(label, 10, 15);
            }

            function drawEcoChart(dates, eco, fp, sp) {
                const can = document.getElementById('economicChart'), ctx = can.getContext('2d');
                const b = can.parentElement.getBoundingClientRect();
                can.width = b.width * devicePixelRatio; can.height = b.height * devicePixelRatio;
                ctx.scale(devicePixelRatio, devicePixelRatio);
                const f = eco.fastEma.slice(-dates.length), s = eco.slowEma.slice(-dates.length);
                const all = [...f.filter(v=>v), ...s.filter(v=>v)];
                const min = Math.min(...all), max = Math.max(...all);
                const m = {t:20, b:20, l:50, r:10}, w = b.width, h = b.height;
                const getX = (i) => m.l + (i/(dates.length-1))*(w-m.l-m.r);
                const getY = (v) => h - m.b - ((v-min)/(max-min))*(h-m.t-m.b);
                const drawL = (d, col) => {
                    ctx.beginPath(); ctx.strokeStyle = col;
                    d.forEach((v, i) => { if(v) i===0?ctx.moveTo(getX(i), getY(v)):ctx.lineTo(getX(i), getY(v)); });
                    ctx.stroke();
                };
                drawL(f, '#3273dc'); drawL(s, '#23d160');
                ctx.fillStyle = '#a0a0a0'; ctx.fillText(`Job Openings (${fp}/${sp})`, 10, 15);
            }

            // --- SECTION 7: SETTINGS MANAGEMENT ---
            function updateCurrentPhaseStatus(ph, dt, s) {
                const cur = ph[ph.length-1];
                currentPhaseStatus.textContent = cur.replace('_',' ') + " (" + dt[dt.length-1] + ")";
                currentPhaseStatus.style.color = s[cur.toLowerCase() + 'Color'];
            }

            function getFilterStartIndex(p) {
                const tp = allDates.length;
                if (p === 'all') return 0;
                return Math.max(0, tp - Math.floor(parseInt(p) * 52.17));
            }

            function buildSettingsPage() {
                const container = document.getElementById('settingsContainer');
                container.innerHTML = `
                    <h2 class="title is-4 has-text-light">Chart Display</h2>
                    <div class="field settings-field"><label class="label">Time Period</label><div class="select is-fullwidth"><select id="timePeriodSelector">
                        <option value="all">All Time</option><option value="10">10 Years</option><option value="5">5 Years</option><option value="3">3 Years</option><option value="1">1 Year</option>
                    </select></div></div>
                    <hr style="background-color: var(--dark-border);">
                    <h2 class="title is-4 has-text-light">MA Periods</h2>
                    <div class="field settings-field"><label class="label">Fast EMA</label><input class="input" type="number" id="fastEmaInput"></div>
                    <div class="field settings-field"><label class="label">Slow EMA</label><input class="input" type="number" id="slowEmaInput"></div>
                    <div class="field settings-field"><label class="label">SMA 1</label><input class="input" type="number" id="sma1Input"></div>
                    <div class="field settings-field"><label class="label">SMA 2</label><input class="input" type="number" id="sma2Input"></div>
                    <hr style="background-color: var(--dark-border);">
                    <h2 class="title is-4 has-text-light">Pre-Downtrend Trigger</h2>
                    <div class="slider-container"><input class="slider is-fullwidth is-info" type="range" id="preDowntrendHistogramsInput" min="1" max="10"><span id="preDowntrendHistogramsValue" class="tag is-info">3</span></div>
                    <hr style="background-color: var(--dark-border);">
                    <h2 class="title is-4 has-text-light">Phase Colors</h2>
                    <div class="field settings-field"><label class="label">New Uptrend</label><input class="input" type="color" id="new_uptrendColorInput"></div>
                    <div class="field settings-field"><label class="label">Late Uptrend</label><input class="input" type="color" id="late_uptrendColorInput"></div>
                    <div class="field settings-field"><label class="label">Warning</label><input class="input" type="color" id="pre_downtrendColorInput"></div>
                    <div class="field settings-field"><label class="label">Downtrend</label><input class="input" type="color" id="downtrendColorInput"></div>
                `;
                const ids = ['timePeriodSelector', 'fastEmaInput', 'slowEmaInput', 'sma1Input', 'sma2Input', 'new_uptrendColorInput', 'late_uptrendColorInput', 'pre_downtrendColorInput', 'downtrendColorInput', 'preDowntrendHistogramsInput'];
                ids.forEach(id => document.getElementById(id).onchange = () => { saveSettings(); processAndDraw(); });
                document.getElementById('preDowntrendHistogramsInput').oninput = (e) => document.getElementById('preDowntrendHistogramsValue').textContent = e.target.value;
            }

            function getSettings() {
                const defaults = { timePeriod:'5', fastEma:'10', slowEma:'20', sma1:'50', sma2:'200', preDowntrendHistograms:'3', new_uptrendColor:'#04aa6d', late_uptrendColor:'#ffdd57', pre_downtrendColor:'#ff9800', downtrendColor:'#ff3860' };
                const saved = localStorage.getItem(SETTINGS_KEY);
                return saved ? {...defaults, ...JSON.parse(saved)} : defaults;
            }

            function loadSettings() {
                const s = getSettings();
                Object.keys(s).forEach(k => {
                    const suffix = k.includes('Color') ? 'Input' : k === 'preDowntrendHistograms' ? 'Input' : k === 'timePeriod' ? 'Selector' : 'Input';
                    const el = document.getElementById(k + suffix);
                    if(el) el.value = s[k];
                });
                document.getElementById('preDowntrendHistogramsValue').textContent = s.preDowntrendHistograms;
            }

            function saveSettings() {
                const s = {};
                ['timePeriod', 'fastEma', 'slowEma', 'sma1', 'sma2', 'preDowntrendHistograms', 'new_uptrendColor', 'late_uptrendColor', 'pre_downtrendColor', 'downtrendColor'].forEach(k => {
                    const suffix = k.includes('Color') ? 'Input' : k === 'preDowntrendHistograms' ? 'Input' : k === 'timePeriod' ? 'Selector' : 'Input';
                    s[k] = document.getElementById(k + suffix).value;
                });
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
            }
        })();
    </script>
</body>
</html>